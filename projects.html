<html>

<head>
    <title>
        brad space invaders
    </title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #game{
            display: none;
            }
        #gameDisplay{
            background-color: black;
        }
        #UI{
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        button{
            color: limegreen;
            background-color: black;
            border-radius: 10px;
        }
        #highscores{
            display: none;
        }
    </style>
</head>

<body id="gameDisplay">
    <div id="UI">
    <button onclick=gameStart();>play a game</button>
    <button onclick=showScores();>local high scores</button>
    </div>
    <div id="highScores">
        *cricket noises
    </div>
    <div id="game">
    <script>
        function showScores(){
            if($("highScores").css("display" == "flex")){
                $("highScores").css("display", "none");
            }
            else{
                $("highScores").css("display", "flex");
            }
        }
        function gameStart(){
            console.log("BEGIN!!")
            $("startButton").css("display", "none");
            $("#game").css("display", "flex");    
        }

        const phaserConfig = {
            type: Phaser.AUTO,
            parent: "game",
            width: 1280,
            height: 720,
            scale: {
                mode: Phaser.Scale.FIT,

            },
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: {},
                    debug: false
                }
            },
            backgroundColor: "#5DACD8",
            scene: {
                init: initScene,
                preload: preloadScene,
                create: createScene,
                update: updateScene
            }
        };

        const game = new Phaser.Game(phaserConfig);
        var cursors;
        var ship;
        var bulletCount = 0;
        var invaders;
        var spawnTimer = 5000;
        var bullet;
        var bomb;
        var bombCount = 0;
        var explosion;
        var lifeCount = 3;
        var lifeDisplay;
        var scoreBoard = 0;
        var ammo;
        var ammoCount = 45;
        var ammoSpawn = 20000;

        function initScene() { }
        function preloadScene(
        ) {
            this.load.image("background", "/assets/retrospace2.jpg");
            this.load.image("bomb", "/assets/Bomb.png");
            this.load.image("ship", "/assets/retrospaceship.png");
            this.load.image('spark', '/assets/blue-flare.png');
            this.load.image('invader', '/assets/space_invader.png');
            this.load.image('bullet', '/assets/blue-flare.png');
            this.load.image('explosion', '/assets/explosion.png');
            this.load.image('ammo', '/assets/santa_hat.png');

        }
        function createScene() {

            this.scale.displaySize.setAspectRatio(16 / 8);
            this.scale.refresh();

            cursors = this.input.keyboard.createCursorKeys();
            background = this.add.tileSprite(640, 200, 1280, 1000, "background");

            ship = this.physics.add.sprite(100, 450, 'ship');
            //brad = this.physics.add.sprite(100, 150, 'brad');

            ship.setCollideWorldBounds(true);

            ship.setBounce(1, 1);

            //brad.body.onWorldBounds = true; //HANDY DANDY
            //this.physics.add.collider(ship, brad)
            //this.physics.overlap(this.brad, this.ship, onWorldBounds);
            //this.physics.world.on('worldbounds', onWorldBounds); needs function 
            //Phaser.Geom.Intersects.RectangleToRectangle(brad, ship)


            invaders = this.add.group();

            window.setInterval(() => {
                let invader = this.physics.add.sprite(1280, Phaser.Math.Between(0, 640), 'invader')
                invaders.add(invader);
                invader.setCollideWorldBounds(true);
                this.physics.add.collider(invader, invaders)
                invader.setBounce(1, 1);
                invader.setVelocityX(Phaser.Math.Between(75, 300))
                invader.setVelocityY(Phaser.Math.Between(75, 300))
                var emitter2 = particles.createEmitter({

                    angle: { min: -180, max: 180 },
                    speed: 10,
                    gravityX: 0,
                    lifespan: 400,
                    quantity: 6,
                    scale: { start: 0.1, end: 1 },
                    blendMode: 'ADD'
                });
                emitter2.startFollow(invader);
                // invader.setTarget(this.ship);
                invader["emitter"] = emitter2
            }, spawnTimer)

            var particles = this.add.particles('spark');

            var emitter = particles.createEmitter({

                angle: { min: -180, max: 180 },
                speed: 10,
                gravityX: -550,
                lifespan: 4000,
                quantity: 6,
                scale: { start: 0.1, end: 1 },
                blendMode: 'ADD'
            });
            var particles2 = this.add.particles('spark');

            ship.body.immovable = true;

            emitter.startFollow(ship);
            this.physics.add.collider(ship, invaders, function () {
                ship.setActive(false).setVisible(false);
                ship.body.enable = false
                emitter.remove();
                if(lifeCount == 1){
                    lifeCount = "dead"
                    ammoCount = 0;
                    scoreBoard = 0;
                    
                }
                if(lifeCount > 1){
                lifeCount = lifeCount - 1;
                setTimeout(() => {
                    console.log("respawn");
                   ship.body.enable = true;
                   ship.setActive(true).setVisible(true);
                    ship.x = 50;
                    ship.y = 350;
                }, 2000)}
              
            }); 
            setInterval(()  => {
                let ammo = this.physics.add.sprite(1280, Phaser.Math.Between(0, 640), 'ammo')
                this.physics.add.collider(ship, ammo, () =>{ammo.destroy(); ammoCount += 20});
                ammo.setVelocityX(-500);
            }, ammoSpawn);
            this.ammoDisplay = this.add.text(500, 10, ammoCount, { fontFamily: 'Verdana, "Times New Roman", Tahoma, serif', fontSize: 64, color: '#00ffff' });
            this.scoreDisplay = this.add.text(1000, 10, scoreBoard, { fontFamily: 'Verdana, "Times New Roman", Tahoma, serif', fontSize: 64, color: '#ffff00' });
            this.lifeDisplay = this.add.text(10, 10, lifeCount, { fontFamily: 'Verdana, "Times New Roman", Tahoma, serif', fontSize: 64, color: '#ff00ff' });
        }
        function updateScene() {
          
            // game.physics.arcade.collide(ship, brad);
            // game.physics.arcade.collide(ship, brad, youDied);
            this.lifeDisplay.setText(lifeCount);
            this.ammoDisplay.setText(ammoCount);
            this.scoreDisplay.setText(scoreBoard);

            background.tilePositionX += .25;
            if (ship.active) {
                if (cursors.left.isDown) {
                    ship.setVelocityX(-200);
                }
                else if (cursors.right.isDown) {
                    ship.setVelocityX(400);
                }
                else {
                    ship.setVelocityX(0);
                }

                if (cursors.up.isDown) {
                    ship.setVelocityY(-100);
                }

                else if (cursors.down.isDown) {
                    ship.setVelocityY(100);
                    //spawnTimer = 50;
                }
                else {
                    ship.setVelocityY(0);
                }
                if (cursors.space.isDown && bombCount == 0) {
                    bomb = this.physics.add.sprite(ship.x + 90, ship.y, 'bomb');
                    bomb.setVelocityX(450);
                    this.physics.add.collider(bomb, invaders, function (bomb, invader) {
                        invader.emitter.remove(); invader.destroy();   
                    })
                   // explosion = this.physics.add.sprite(bomb.x, bomb.y, 'explosion');
                    bombCount = 1;
                    ammoCount -= 1;

                    setTimeout(() => {
                        bombCount = 0;
                    }, 250);
                }
                if (cursors.shift.isDown && bulletCount == 0) {
                    bullet = this.physics.add.sprite(ship.x + 30, ship.y - 62, 'bullet');
                    bullet.setVelocityX(1000);
                    this.physics.add.collider(bullet, invaders, function (bullet, invader) { invader.emitter.remove(); invader.destroy(); scoreBoard++;})
                    bullet = this.physics.add.sprite(ship.x + 30, ship.y + 62, 'bullet');
                    bullet.setVelocityX(1000);
                    this.physics.add.collider(bullet, invaders, function (bullet, invader) { invader.emitter.remove(); invader.destroy(); scoreBoard++; })
                    this.physics.world.on('worldBounds', function () { bullet.destroy(); console.log("bullet removed") })
                    bulletCount = 1;
                    ammoCount -= 1;
                    setTimeout(() => {
                        bulletCount = 0;
                    }, 600);

                }
                // if(cursors.e.isDown){
                //     scoreBoard += 1000;
                // }
            }

        }
    </script>
    </div>
</body>

</html>
