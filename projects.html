<html>

<head>
    <title>
        brad space invaders
    </title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.min.js"></script>
</head>

<body>
    <div id="game"></div>
    <script>

        const phaserConfig = {
            type: Phaser.AUTO,
            parent: "game",
            width: 1280,
            height: 720,
            scale: {
                mode: Phaser.Scale.FIT,

            },
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: {},
                    debug: false
                }
            },
            backgroundColor: "#5DACD8",
            scene: {
                init: initScene,
                preload: preloadScene,
                create: createScene,
                update: updateScene
            }
        };

        const game = new Phaser.Game(phaserConfig);
        var cursors;
        var ship;

        var invaders;
        var spawnTimer = 5000;
        var bullet;

        function initScene() { }
        function preloadScene(
        ) {
            this.load.image("background", "/assets/retrospace2.jpg");

            this.load.image("ship", "/assets/retrospaceship.png");
            this.load.image('spark', '/assets/blue-flare.png');
            this.load.image('invader', '/assets/space_invader.png');
            this.load.image('bullet', '/assets/blue-flare.png');

        }
        function createScene() {

            this.scale.displaySize.setAspectRatio(16 / 8);
            this.scale.refresh();

            cursors = this.input.keyboard.createCursorKeys();
            background = this.add.tileSprite(640, 200, 1280, 1000, "background");

            ship = this.physics.add.sprite(100, 450, 'ship');
            //brad = this.physics.add.sprite(100, 150, 'brad');

            ship.setCollideWorldBounds(true);

            ship.setBounce(1, 1);

            //brad.body.onWorldBounds = true; //HANDY DANDY
            //this.physics.add.collider(ship, brad)
            //this.physics.overlap(this.brad, this.ship, onWorldBounds);
            //this.physics.world.on('worldbounds', onWorldBounds); needs function 
            //Phaser.Geom.Intersects.RectangleToRectangle(brad, ship)

            invaders = this.add.group();

            window.setInterval(() => {
                let invader = this.physics.add.sprite(1280, Phaser.Math.Between(0, 640), 'invader')
                invaders.add(invader);
                invader.setCollideWorldBounds(true);
                this.physics.add.collider(invader, invaders)
                invader.setBounce(1, 1);
                invader.setVelocityX(Phaser.Math.Between(75, 300))
                invader.setVelocityY(Phaser.Math.Between(75, 300))
                var emitter2 = particles.createEmitter({

                    angle: { min: -180, max: 180 },
                    speed: 10,
                    gravityX: 0,
                    lifespan: 400,
                    quantity: 6,
                    scale: { start: 0.1, end: 1 },
                    blendMode: 'ADD'
                });
                emitter2.startFollow(invader);
                // invader.setTarget(this.ship);
                invader["emitter"] = emitter2
            }, spawnTimer)

            var particles = this.add.particles('spark');

            var emitter = particles.createEmitter({

                angle: { min: -180, max: 180 },
                speed: 10,
                gravityX: -350,
                lifespan: 4000,
                quantity: 6,
                scale: { start: 0.1, end: 1 },
                blendMode: 'ADD'
            });
            var particles2 = this.add.particles('spark');

            ship.body.immovable = true;

            emitter.startFollow(ship);
            this.physics.add.collider(ship, invaders, function () {
                ship.destroy();

                setTimeout(() => {
                    console.log("respawn");
                    ship = game.physics.add.sprite(100, 450, 'ship');
                }, 2000)
                emitter.remove();
            });
        }
        function updateScene() {
            // game.physics.arcade.collide(ship, brad);
            // game.physics.arcade.collide(ship, brad, youDied);

            background.tilePositionX += .25;
            if (ship.active) {
                if (cursors.left.isDown) {
                    ship.setVelocityX(-200);
                }
                else if (cursors.right.isDown) {
                    ship.setVelocityX(400);
                }
                else {
                    ship.setVelocityX(0);
                }

                if (cursors.up.isDown) {
                    ship.setVelocityY(-100);
                }

                else if (cursors.down.isDown) {
                    ship.setVelocityY(100);
                    //spawnTimer = 50;
                }
                else {
                    ship.setVelocityY(0);
                }
                if (cursors.space.isDown) {  
                    bullet = this.physics.add.sprite(ship.x + 90, ship.y, 'bullet');
                    //bullet = this.physics.add.sprite(ship.x +30, ship.y + 62, 'bullet');
                    bullet.setVelocityX(1000);
                    this.physics.add.collider(bullet, invaders, function (bullet, invader) { invader.emitter.remove(); invader.destroy(); }) 
                    // bullet = this.physics.add.sprite(ship.x +30, ship.y - 62, 'bullet');
                    // bullet.setVelocityX(1000);
                    // this.physics.add.collider(bullet, invaders, function (bullet, invader) { invader.emitter.remove(); invader.destroy(); })
                   // this.physics.world.on('worldBounds', function(){bullet.destroy(); console.log("bullet removed")})

                }
            }

        }
    </script>
</body>

</html>
